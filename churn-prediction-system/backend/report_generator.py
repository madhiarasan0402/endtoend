from fpdf import FPDF
import os
import math
from datetime import datetime

class PDFReport(FPDF):
    def header(self):
        self.set_font('Arial', 'B', 15)
        self.cell(80)
        self.cell(30, 10, 'ChurnShield Pro - Intelligence Report', 0, 0, 'C')
        self.ln(20)
        self.set_draw_color(0, 0, 0)
        self.line(10, 25, 200, 25)

    def footer(self):
        self.set_y(-15)
        self.set_font('Arial', 'I', 8)
        self.cell(0, 10, 'Page ' + str(self.page_no()) + '/{nb}' + ' | Generated by ChurnShield AI', 0, 0, 'C')

    def sector(self, xc, yc, r, a1, a2, style='FD', cw=True, o=90):
        if cw:
            d = a1
            a1 = o - a2
            a2 = o - d
        else:
            a1 += o
            a2 += o
        
        a1 = math.radians(a1)
        a2 = math.radians(a2)
        da = a2 - a1
        
        if da < 0:
            da += 2 * math.pi
        
        if da == 0:
            return
        
        # Move to center
        self._out(f'{xc * self.k:.2f} {(self.h - yc) * self.k:.2f} m')
        # Line to first point
        self._out(f'{(xc + r * math.cos(a1)) * self.k:.2f} {(self.h - (yc - r * math.sin(a1))) * self.k:.2f} l')
        
        step_deg = 5 * (math.pi / 180) # 5 degrees steps
        curr_a = a1
        while curr_a < a2:
            curr_a += step_deg
            if curr_a > a2: curr_a = a2
            self._out(f'{(xc + r * math.cos(curr_a)) * self.k:.2f} {(self.h - (yc - r * math.sin(curr_a))) * self.k:.2f} l')
            
        self._out(f'{xc * self.k:.2f} {(self.h - yc) * self.k:.2f} l')
        
        if style =='F': op = 'f'
        elif style =='FD' or style=='DF': op = 'b'
        else: op = 's'
        
        self._out(op)

def generate_report(data):
    pdf = PDFReport()
    pdf.alias_nb_pages()
    pdf.add_page()
    pdf.set_font('Arial', '', 12)
    
    # 1. Executive Summary
    pdf.set_font('Arial', 'B', 14)
    pdf.cell(0, 10, '1. Executive Analysis', 0, 1)
    pdf.set_font('Arial', '', 11)
    
    customer_id = data.get('customer_id', 'Unknown')
    risk_level = data.get('risk_level', 'Unknown')
    prob = float(data.get('churn_probability', 0))
    prob_percent = round(prob * 100, 2)
    
    pdf.cell(0, 8, f"Customer Identifier: {customer_id}", 0, 1)
    pdf.cell(0, 8, f"Assessment Date: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}", 0, 1)
    
    pdf.ln(5)
    pdf.set_fill_color(240, 240, 240)
    pdf.cell(0, 10, f"  Predicted Churn Risk: {risk_level} ({prob_percent}%)", 1, 1, 'L', 1)
    
    pdf.ln(10)
    
    # --- 2. Side-by-Side Section ---
    y_start = pdf.get_y()
    
    # LEFT COLUMN: Key Risk Drivers
    pdf.set_font('Arial', 'B', 14)
    pdf.cell(110, 10, '2. Key Risk Drivers (Neural Weights)', 0, 1)
    pdf.set_font('Arial', '', 11)
    
    explanations = data.get('explanations', [])
    if explanations:
        for exp in explanations:
            feature = exp.get('feature', 'Unknown')
            impact = exp.get('impact', 0)
            direction = "Increased Risk" if impact > 0 else "Decreased Risk"
            # Truncate if too long to fit in half page
            text = f"- {feature}: {direction} ({impact:.4f})"
            if len(text) > 55: text = text[:52] + "..."
            pdf.cell(110, 8, text, 0, 1)
    else:
        pdf.cell(110, 8, "No specific drivers identified.", 0, 1)
        
    y_end_text = pdf.get_y()
    
    # RIGHT COLUMN: Chart
    # Center of right area = 110 + (210-10-110)/2 = 155
    xc = 160
    yc = y_start + 30
    radius = 18
    
    # 1. Background Circle (Grey)
    pdf.set_fill_color(240, 240, 240)
    pdf.sector(xc, yc, radius, 0, 360, 'F')
    
    # 2. Value Sector (Color)
    if prob > 0.7:
        pdf.set_fill_color(220, 20, 60) # Crimson
    elif prob > 0.4:
        pdf.set_fill_color(251, 191, 36) # Amber
    else:
        pdf.set_fill_color(16, 185, 129) # Emerald
        
    # Draw sector from 0 to angle
    angle = prob * 360
    pdf.sector(xc, yc, radius, 0, angle, 'F')
    
    # 3. Inner White Circle (Doughnut hole)
    pdf.set_fill_color(255, 255, 255)
    inner_radius = radius * 0.75
    pdf.sector(xc, yc, inner_radius, 0, 360, 'F')
    
    # 4. Text inside
    pdf.set_xy(xc - 15, yc - 5)
    pdf.set_font('Arial', 'B', 16)
    pdf.set_text_color(0, 0, 0)
    pdf.cell(30, 10, f"{int(prob_percent)}%", 0, 0, 'C')
    
    pdf.set_xy(xc - 15, yc + 3)
    pdf.set_font('Arial', 'B', 6)
    pdf.set_text_color(100, 100, 100)
    pdf.cell(30, 10, "PROBABILITY", 0, 0, 'C')
    
    # Reset cursor to below the lowest point
    final_y = max(y_end_text, yc + radius + 10)
    pdf.set_y(final_y)
    pdf.set_text_color(0, 0, 0)
    
    # -------------------------------
    
    # 3. Customer Profile
    pdf.set_font('Arial', 'B', 14)
    pdf.cell(0, 10, '3. Customer Telemetry', 0, 1)
    pdf.set_font('Arial', '', 10)
    
    ignore_keys = ['explanations', 'churn_probability', 'risk_level', 'customer_id', 'inputData'] 
    
    keys = [k for k in data.keys() if k not in ignore_keys]
    col_width = 90
    row_height = 7
    for i, key in enumerate(keys):
        val = str(data[key])
        pdf.cell(col_width, row_height, f"{key}: {val}", 1, 0)
        if i % 2 == 1:
            pdf.ln(row_height)
            
    pdf.ln(20)
    
    # 4. Recommended Actions
    pdf.set_font('Arial', 'B', 14)
    pdf.cell(0, 10, '4. Strategic Recommendations', 0, 1)
    pdf.set_font('Arial', '', 11)
    
    if risk_level == 'High':
        pdf.multi_cell(0, 8, "PRIORITY: Immediate intervention required.\n- Schedule executive review call.\n- Offer 12+ month contract incentive.\n- Review technical support tickets for unresolved issues.")
    elif risk_level == 'Medium':
        pdf.multi_cell(0, 8, "MONITOR: Customer is at risk.\n- Send satisfaction survey.\n- Highlight value-add features relevant to usage.\n- Monitor usage drop-offs.")
    else:
        pdf.multi_cell(0, 8, "RETAIN: Healthy status.\n- Consider upsell opportunities.\n- Invite to loyalty program.\n- Request referral.")
        
    try:
        return pdf.output(dest='S').encode('latin-1')
    except:
        return pdf.output(dest='S')
